> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [chat.zchat.tech](https://chat.zchat.tech/c/6912b03b-a5bc-832a-8a72-7c478c14034b)

> ChatGPT helps you get answers, find inspiration and be more productive. It is free to use and easy to......

è¿™ä¸€èŠ‚ï¼ˆ**7.9 Process Locking**ï¼‰è®²çš„æ˜¯ xv6 ä¸­æœ€å¤æ‚ã€æœ€å…³é”®çš„ä¸€æŠŠé”â€”â€”  
**`p->lock`ï¼ˆæ¯ä¸ªè¿›ç¨‹çš„ä¸“å±é”ï¼‰**ã€‚

å®ƒçš„ä½œç”¨è¿œè¿œä¸æ­¢æ˜¯ â€œä¿æŠ¤å‡ ä¸ªå­—æ®µâ€ï¼Œè€Œæ˜¯æ”¯æ’‘æ•´ä¸ª xv6 å†…æ ¸ä¸­**è¿›ç¨‹çŠ¶æ€è½¬æ¢ã€è°ƒåº¦ã€ç¡çœ å”¤é†’ã€é€€å‡ºç­‰æ ¸å¿ƒæœºåˆ¶çš„æ­£ç¡®æ€§**ã€‚  
ä¸‹é¢æˆ‘ä»¬æ¥ç³»ç»Ÿåœ°æ¢³ç†è¿™ä¸€èŠ‚çš„é‡ç‚¹ã€‚

ğŸ§© ä¸€ã€`p->lock` çš„åŸºæœ¬èŒè´£ï¼šä¿æŠ¤è¿›ç¨‹çŠ¶æ€å­—æ®µ
-----------------------------

æœ€ç›´æ¥çš„åŠŸèƒ½æ˜¯ä¿æŠ¤è¿›ç¨‹è¡¨ï¼ˆ`struct proc`ï¼‰ä¸­é‚£äº›**å¯èƒ½è¢«å¤šä¸ª CPU æˆ–è°ƒåº¦å™¨çº¿ç¨‹åŒæ—¶è®¿é—®çš„å…³é”®å­—æ®µ**ï¼š

> å½“è®¿é—®æˆ–ä¿®æ”¹ä»¥ä¸‹å­—æ®µæ—¶ï¼Œå¿…é¡»æŒæœ‰ `p->lock`ï¼š
> 
> ```
> struct context {
>   uint64 ra;
>   uint64 sp;
>   uint64 s0; â€¦ uint64 s11;
> };
> ```

åŸå› ï¼š  
è¿™äº›å­—æ®µå¯èƒ½ä¼šè¢«ï¼š

*   å½“å‰è¿›ç¨‹è‡ªå·±ä¿®æ”¹ï¼›
    
*   è°ƒåº¦å™¨ï¼ˆåœ¨åˆ«çš„ CPU æ ¸ä¸Šï¼‰è¯»å–ï¼›
    
*   æˆ–å…¶ä»–è¿›ç¨‹ï¼ˆå¦‚çˆ¶è¿›ç¨‹çš„ `wait()`ï¼‰è®¿é—®ã€‚
    

å› æ­¤å¿…é¡»ç”¨ `p->lock` ä¿è¯**è¯»å†™äº’æ–¥**ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹å¸¦æ¥ç«æ€ã€‚

âš™ï¸ äºŒã€æ›´æ·±å±‚ä½œç”¨ï¼šä¿æŠ¤æ›´é«˜å±‚çš„å†…æ ¸è¡Œä¸º
---------------------

xv6 ä¸­ï¼Œ`p->lock` ä¸ä»…ä»…æ˜¯ä¿æŠ¤ â€œå˜é‡â€ï¼Œ  
å®ƒè¿˜éšå«åœ°ä¿æŠ¤äº†**ä¸€æ•´å¥—è¿›ç¨‹çŠ¶æ€æœºçš„åŸå­æ€§**ã€‚  
å…·ä½“æ¥è¯´ï¼Œå®ƒæ‰¿æ‹…äº†ä»¥ä¸‹å…«ä¸ªå…³é”®èŒè´£ï¼š

### **1ï¸âƒ£ è¿›ç¨‹åˆ†é…æ—¶é˜²æ­¢ç«äº‰**

> â€œAlong with p->state, it prevents races in allocating proc[] slots for new processes.â€
<!--ID: 1764664441416-->


åœ¨åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼ˆ`allocproc()`ï¼‰ï¼Œ  
ç³»ç»Ÿä» `proc[]` æ•°ç»„ä¸­æ‰¾ä¸€ä¸ª `UNUSED` æ§½ä½ï¼›  
å¿…é¡»åœ¨æŒé”çŠ¶æ€ä¸‹æŠŠå®ƒæ”¹æˆ `USED`ï¼Œ  
å¦åˆ™ä¸¤ä¸ª CPU å¯èƒ½åˆ†é…åˆ°åŒä¸€ä¸ªæ§½ä½ã€‚

### **2ï¸âƒ£ åˆ›å»º / é”€æ¯æ—¶ â€œéšèº«â€ ä¿æŠ¤**

> â€œIt conceals a process from view while it is being created or destroyed.â€
<!--ID: 1764664441419-->


å½“è¿›ç¨‹åˆšåˆ›å»ºï¼ˆçŠ¶æ€æœªå®Œå…¨åˆå§‹åŒ–ï¼‰æˆ–åˆšé”€æ¯ï¼ˆèµ„æºæœªå®Œå…¨é‡Šæ”¾ï¼‰æ—¶ï¼Œ  
å…¶ä»– CPU ä¸åº”è¯¥ â€œçœ‹åˆ°â€ è¿™ä¸ªè¿›ç¨‹ã€‚  
`p->lock` ç¡®ä¿åœ¨è¿™äº›ä¸­é—´é˜¶æ®µå†…æ²¡æœ‰å…¶ä»–æ ¸å¿ƒæ¥è®¿é—®è¯¥ç»“æ„ã€‚

### **3ï¸âƒ£ é˜²æ­¢çˆ¶è¿›ç¨‹ææ—©æ”¶å°¸**

> â€œIt prevents a parentâ€™s wait from collecting a process that has set its state to ZOMBIE but has not yet yielded the CPU.â€
<!--ID: 1764664441421-->


`exit()` æŠŠå­è¿›ç¨‹çŠ¶æ€è®¾ä¸º `ZOMBIE` åï¼Œè¿˜è¦å†åˆ‡æ¢å›è°ƒåº¦å™¨ã€‚  
`p->lock` ä¿è¯çˆ¶äº² `wait()` ä¸ä¼šåœ¨ `exit()` è¿˜æ²¡ `swtch` å‰ â€œè¿‡æ—©å›æ”¶â€ è¯¥å­è¿›ç¨‹ã€‚

> å³ï¼šåªæœ‰å½“ `scheduler` çœŸæ­£é‡Šæ”¾äº†é”åï¼Œçˆ¶è¿›ç¨‹æ‰å¯èƒ½ `wait()` åˆ°å®ƒã€‚

### **4ï¸âƒ£ é˜²æ­¢å¤šæ ¸è°ƒåº¦å™¨é‡å¤è°ƒåº¦åŒä¸€ä¸ªè¿›ç¨‹**

> â€œIt prevents another coreâ€™s scheduler from deciding to run a yielding process after it sets its state to RUNNABLE but before it finishes swtch.â€
<!--ID: 1764664441425-->


åœ¨ `yield()` æˆ– `sched()` ä¸­ï¼Œè¿›ç¨‹ä¼šï¼š

1.  å…ˆæ”¹çŠ¶æ€ä¸º `RUNNABLE`ï¼›
    
2.  å†è°ƒç”¨ `swtch()`ã€‚
    

å¦‚æœæ­¤æ—¶ä¸æŒé”ï¼Œå¦ä¸€ä¸ª CPU çš„è°ƒåº¦å™¨å¯èƒ½çœ‹åˆ°è¯¥è¿›ç¨‹æ˜¯ RUNNABLEï¼Œ  
æå‰åˆé€‰ä¸­å®ƒè¿è¡Œï¼Œè¿™æ ·ä¸¤ä¸ª CPU åŒæ—¶è·‘ä¸€ä¸ªæ ˆâ€”â€”ç¾éš¾ã€‚

`p->lock` ä¿è¯åœ¨ `swtch` å®Œæˆå‰è°ƒåº¦å™¨çœ‹ä¸åˆ°è¿™ä¸ªçŠ¶æ€å˜åŒ–ã€‚

### **5ï¸âƒ£ ç¡®ä¿åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨é€‰ä¸­æŸä¸ªè¿›ç¨‹**

> â€œIt ensures that only one coreâ€™s scheduler decides to run a RUNNABLE process.â€
<!--ID: 1764664441429-->


`p->lock` é˜²æ­¢å¤šä¸ªè°ƒåº¦å™¨åŒæ—¶é€‰ä¸­åŒä¸€ä¸ª RUNNABLE è¿›ç¨‹ï¼›  
é€‰ä¸­ä¸è¿è¡Œçš„æ“ä½œéƒ½æ˜¯åœ¨æŒé”çŠ¶æ€ä¸‹å®Œæˆçš„ã€‚

### **6ï¸âƒ£ é˜²æ­¢å®šæ—¶å™¨ä¸­æ–­åœ¨ swtch å†…æ‰“æ–­è¿›ç¨‹**

> â€œIt prevents a timer interrupt from causing a process to yield while it is in swtch.â€
<!--ID: 1764664441433-->


å¦‚æœåœ¨ `swtch()`ï¼ˆæ±‡ç¼–çº§ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰æ‰§è¡Œåˆ°ä¸€åŠæ—¶è¢«æ—¶é’Ÿä¸­æ–­æ‰“æ–­ï¼Œ  
é‚£ CPU ç°åœºä¼šéå¸¸æ··ä¹±ã€‚  
æŒæœ‰ `p->lock` æ—¶å†…æ ¸ä¼š**å…³é—­ä¸­æ–­**ï¼Œä»è€Œé¿å…è¿™ç§ç¾éš¾ã€‚

### **7ï¸âƒ£ ååŠ© sleep/wakeup é˜²æ­¢ä¸¢å”¤é†’**

> â€œAlong with the condition lock, it helps prevent wakeup from overlooking a process that is calling sleep but has not finished yielding the CPU.â€
<!--ID: 1764664441436-->


å½“ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œ `sleep(chan, lock)` æ—¶ï¼š

*   å®ƒå…ˆè·å¾— `p->lock`ï¼›
    
*   å†é‡Šæ”¾æ¡ä»¶é”ï¼›
    
*   ç„¶åè®¾ç½® `SLEEPING` çŠ¶æ€ï¼›
    
*   æœ€å `swtch()` åˆ‡å‡ºã€‚
    

åœ¨è¿™ä¸€ç³»åˆ—æ“ä½œä¸­ï¼Œ`p->lock` ä¸æ¡ä»¶é” (`lock`) ä¸€èµ·ä¿è¯å”¤é†’æ–¹ä¸ä¼šé”™è¿‡è¿™ä¸ª â€œåŠç¡çœ â€ çŠ¶æ€ï¼Œä»è€Œé˜²æ­¢ **lost wakeup**ã€‚

### **8ï¸âƒ£ é˜²æ­¢ kill ç«æ€**

> â€œIt prevents the victim process of kill from exiting and perhaps being re-allocated between killâ€™s check of p->pid and setting p->killed.â€
<!--ID: 1764664441439-->


å‡è®¾ A è°ƒç”¨ `kill(pid)`ï¼š

*   å®ƒå…ˆæ‰«æ `proc[]`ï¼›
    
*   å†æ£€æŸ¥ `p->pid`ï¼›
    
*   ç„¶åè®¾ç½® `p->killed = 1`ã€‚
    

å¦‚æœç›®æ ‡è¿›ç¨‹åœ¨è¿™æœŸé—´åˆšå¥½é€€å‡ºå¹¶è¢«é‡ç”¨ä¸ºæ–°è¿›ç¨‹ï¼Œ  
é‚£å°±å¯èƒ½è¯¯æ€æ–°è¿›ç¨‹ã€‚  
æŒæœ‰ `p->lock` å¯é˜²æ­¢è¿™ä¸ªç«æ€ã€‚

åŒæ—¶ï¼š

> â€œIt makes killâ€™s check and write of p->state atomic.â€

å³ä¿è¯ `kill()` åœ¨æ£€æŸ¥å’Œä¿®æ”¹çŠ¶æ€æ—¶çš„åŸå­æ€§ã€‚

ğŸ” ä¸‰ã€`wait_lock`ï¼šå¦ä¸€ä¸ªé…åˆ `p->lock` çš„å…³é”®å…¨å±€é”
---------------------------------------

æ–‡æœ«æåˆ°äº†ç¬¬äºŒæŠŠé‡è¦çš„é” â€”â€” **`wait_lock`**ã€‚

> â€œThe p->parent field is protected by the global lock wait_lock rather than by p->lock.â€

è¿™æŠŠé”ç”¨äºï¼š

*   ä¿æŠ¤çˆ¶å­å…³ç³»å­—æ®µ `p->parent`ï¼›
    
*   ä¸²è” `exit` ä¸ `wait` ä¹‹é—´çš„åŒæ­¥ï¼›
    
*   é˜²æ­¢çˆ¶å­åŒæ—¶é€€å‡ºçš„ç«æ€ã€‚
    

### `wait_lock` çš„ç”¨é€”ä¸è®¾è®¡åŸå› ï¼š

1ï¸âƒ£ **çˆ¶å­å…³è”ä¿æŠ¤**
<!--ID: 1764664441441-->


*   çˆ¶è¿›ç¨‹ä¼šä¿®æ”¹ `p->parent`ï¼›
    
*   ä½† `wait()`ã€`exit()`ã€å…¶ä»–è¿›ç¨‹å¯èƒ½åŒæ—¶è¯»å–ï¼›
    
*   æ‰€ä»¥ `wait_lock` æ˜¯è¿™ç±»è®¿é—®çš„å…¨å±€ä¿æŠ¤ã€‚
    

2ï¸âƒ£ **`exit` ä¸ `wait` äº‹ä»¶åŒæ­¥ï¼ˆæ¡ä»¶é”è§’è‰²ï¼‰**

*   å­è¿›ç¨‹é€€å‡º (`exit`) æ—¶æŒæœ‰ `wait_lock`ï¼›
    
*   çˆ¶è¿›ç¨‹ç­‰å¾… (`wait`) æ—¶ä¹ŸæŒæœ‰ï¼›
    
*   ä¿è¯çˆ¶äº²ä¸ä¼šé”™è¿‡å­©å­çš„ `wakeup`ã€‚
    

3ï¸âƒ£ **é¿å…çˆ¶å­åŒæ—¶é€€å‡ºçš„æ­»é”ä¸ç«æ€**

*   ç»Ÿä¸€é”é¡ºåºï¼š**`wait_lock` â†’ `p->lock`**ï¼›
    
*   `wait()` å’Œ `exit()` éƒ½éµå¾ªï¼›
    
*   ä¿è¯ä¸ä¼šå½¢æˆå¾ªç¯ç­‰å¾…ã€‚
    

4ï¸âƒ£ **ä¸ºä»€ä¹ˆæ˜¯å…¨å±€é”**

> â€œwait_lock is a global lock rather than per-parent lock because, until a process acquires it, it cannot know who its parent is.â€

å³ï¼šåªæœ‰æ‹¿åˆ°è¿™æŠŠé”ï¼Œæ‰èƒ½å®‰å…¨åœ°è®¿é—®æˆ–åˆ¤æ–­ `p->parent`ã€‚  
å› æ­¤ä¸èƒ½åšæˆæ¯ä¸ªçˆ¶è¿›ç¨‹ç§æœ‰çš„é”ã€‚

âœ… å››ã€æ€»ç»“ä¸€é¡µè¡¨
---------

<table data-start="3655" data-end="3996"><thead data-start="3655" data-end="3681"><tr data-start="3655" data-end="3681"><th data-start="3655" data-end="3659" data-col-size="sm">é”</th><th data-start="3659" data-end="3666" data-col-size="sm">ä½œç”¨èŒƒå›´</th><th data-start="3666" data-end="3673" data-col-size="md">ä¿æŠ¤å†…å®¹</th><th data-start="3673" data-end="3681" data-col-size="sm">ä¸»è¦é˜²æŠ¤</th></tr></thead><tbody data-start="3739" data-end="3996"><tr data-start="3739" data-end="3836"><td data-start="3739" data-end="3755" data-col-size="sm"><strong data-start="3741" data-end="3754"><code data-start="3743" data-end="3752">p-&gt;lock</code></strong></td><td data-col-size="sm" data-start="3755" data-end="3764">æ¯ä¸ªè¿›ç¨‹ç‹¬æœ‰</td><td data-col-size="md" data-start="3764" data-end="3812">è¿›ç¨‹çŠ¶æ€ï¼ˆstate, chan, killed, xstate, pidï¼‰åŠç›¸å…³è°ƒåº¦é€»è¾‘</td><td data-col-size="sm" data-start="3812" data-end="3836">é˜²æ­¢å¹¶å‘çŠ¶æ€ä¿®æ”¹ã€é‡å¤è°ƒåº¦ã€ä¸¢å”¤é†’ã€è¯¯æ€</td></tr><tr data-start="3837" data-end="3921"><td data-start="3837" data-end="3855" data-col-size="sm"><strong data-start="3839" data-end="3854"><code data-start="3841" data-end="3852">wait_lock</code></strong></td><td data-col-size="sm" data-start="3855" data-end="3860">å…¨å±€</td><td data-col-size="md" data-start="3860" data-end="3886">çˆ¶å­å…³ç³»ï¼ˆp-&gt;parentï¼‰ã€é€€å‡º / ç­‰å¾…åŒæ­¥</td><td data-col-size="sm" data-start="3886" data-end="3921">é˜²æ­¢ <code data-start="3891" data-end="3899">wait()</code> ä¸ <code data-start="3902" data-end="3910">exit()</code> ç«æ€ï¼Œé˜²æ­¢ä¸¢å”¤é†’</td></tr><tr data-start="3922" data-end="3996"><td data-start="3922" data-end="3932" data-col-size="sm"><strong data-start="3924" data-end="3931">é”é¡ºåº</strong></td><td data-col-size="sm" data-start="3932" data-end="3958"><code data-start="3934" data-end="3945">wait_lock</code> â†’ <code data-start="3948" data-end="3957">p-&gt;lock</code></td><td data-col-size="md" data-start="3958" data-end="3969">ç»Ÿä¸€é¡ºåºé˜²æ­¢æ­»é”</td><td data-col-size="sm" data-start="3969" data-end="3996"><code data-start="3971" data-end="3979">exit()</code> ä¸ <code data-start="3982" data-end="3990">wait()</code> å‡éµå®ˆ</td></tr></tbody></table>

ğŸ’¡ ä¸€å¥è¯æ€»ç»“ï¼š
---------

> xv6 çš„ `p->lock` æ˜¯å†…æ ¸ä¸­æœ€æ ¸å¿ƒçš„ä¸€æŠŠé”ï¼Œå®ƒä¸ä»…ä¿æŠ¤è¿›ç¨‹çš„çŠ¶æ€å­—æ®µï¼Œæ›´é€šè¿‡ä¸ `wait_lock` é…åˆï¼Œä¿éšœäº†è¿›ç¨‹åˆ›å»ºã€è°ƒåº¦ã€ç¡çœ ã€å”¤é†’ã€é€€å‡ºã€ç»ˆæ­¢ç­‰ä¸€ç³»åˆ—æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚
> 
> è¿™ä¸¤æŠŠé”å…±åŒç¡®ä¿ï¼š
> 
> *   **è°ƒåº¦å®‰å…¨**ï¼ˆä¸ä¼šå¤šæ ¸é‡å¤è¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼‰
>     
> *   **é€€å‡ºå®‰å…¨**ï¼ˆçˆ¶å­åŒæ­¥ï¼Œä¸ä¸¢å”¤é†’ï¼‰
>     
> *   **æ€æ­»å®‰å…¨**ï¼ˆä¸ä¼šè¯¯æ€é‡ç”¨çš„è¿›ç¨‹ï¼‰
>